import React, { useState, useEffect, useMemo } from 'react'
import AdminLayout from '@/components/AdminLayout'
import ThemeAwareFooter from '@/components/ThemeAwareFooter'
import UserProfileModal from '@/components/UserProfileModal'
import ChangePasswordModal from '@/components/ChangePasswordModal'
import AssetPickerModal, { SelectedAsset } from '@/components/AssetPickerModal'
import { ThemeAwareInput, ThemeAwareSelect, ThemeAwareTextarea } from '@/components/ThemeAwareFormControls'
import BackgroundRenderer from '@/components/theme-backgrounds/BackgroundRenderer'
import { motion } from 'framer-motion'
import {
  Save,
  Globe,
  Mail,
  Phone,
  MapPin,
  Settings as SettingsIcon,
  AlertTriangle,
  Image as ImageIcon,
  Building,
  Menu,
  Link,
  Plus,
  Trash2,
  User,
  Key,
  ChevronDown
} from 'lucide-react'
import { useForm, useFieldArray } from 'react-hook-form'
import toast from 'react-hot-toast'
import { settingsApi, authApi } from '@/utils/api'
import { useSettings } from '@/contexts/SettingsContext'
import type { Settings, FooterSection, FooterLayout, FooterSocialLink } from '@/types'
import { getThemeById, resolveBackgroundEffect, type ThemeBackgroundChoice } from '@/styles/themes'
const EMPTY_FOOTER_LAYOUT: FooterLayout = {
  brand: {
    name: '',
    description: '',
    logo: ''
  },
  sections: []
}
const backgroundOptions = [
  { value: 'theme-default', label: '???????????' },
  { value: 'starfield', label: '???????§¹??' },
  { value: 'gradient', label: '???????' },
  { value: 'pattern', label: '???????' }
]
const normalizeFooterLayoutPayload = (layout?: FooterLayout | null): FooterLayout => {
  const sourceLayout = layout ?? EMPTY_FOOTER_LAYOUT
  const brand = (sourceLayout?.brand as FooterLayout['brand']) || EMPTY_FOOTER_LAYOUT.brand
  const timestamp = Date.now()
  const normalizedBrand = {
    name: (brand.name && brand.name.trim()) || '',
    description: brand.description || '',
    logo: brand.logo || ''
  }
  const sectionsSource = Array.isArray(sourceLayout?.sections) ? sourceLayout.sections : []
  const sections = sectionsSource
    .map((section, index) => {
      const linksSource = Array.isArray(section?.links) ? section.links : []
      const links = linksSource
        .filter(link => link && ((link.label && link.label.trim()) || (link.url && link.url.trim())))
        .map((link, linkIndex) => ({
          id: link.id || `link_${index}_${linkIndex}_${timestamp}`,
          label: (link.label && link.label.trim()) || `????${linkIndex + 1}`,
          url: (link.url && link.url.trim()) || '#',
          target: link.target || '_self'
        }))
      return {
        id: section.id || `section_${index}_${timestamp}`,
        title: (section.title && section.title.trim()) || `???${index + 1}`,
        description: section.description || '',
        links
      }
    })
    .filter(section => section.title || section.links.length)
  return {
    brand: normalizedBrand,
    sections
  }
}
const sanitizeColorValue = (value?: string | null) => {
  if (typeof value !== 'string') return ''
  return value.trim()
}

const sanitizeFooterSocialLinksPayload = (links?: FooterSocialLink[] | null): FooterSocialLink[] => {
  const timestamp = Date.now()
  const source = Array.isArray(links) ? links : []
  const sanitized: FooterSocialLink[] = source
    .filter(link => link && ((link.label && link.label.trim()) || (link.url && link.url.trim())))
    .map((link, index) => ({
      id: link.id || `social_${index}_${timestamp}`,
      label: (link.label && link.label.trim()) || `?ÁW????${index + 1}`,
      url: (link.url && link.url.trim()) || '#',
      icon: link.icon || '',
      target: link.target === '_self' ? '_self' : '_blank',
      color: sanitizeColorValue(link.color)
    }))
  return sanitized
}
const sanitizeSettingsPayload = (data: Settings): Settings => {
  const payload = { ...data } as Record<string, any>
  payload.footer_layout = normalizeFooterLayoutPayload(data.footer_layout)
  payload.footer_social_links = sanitizeFooterSocialLinksPayload(data.footer_social_links)
  payload.site_statement = (data.site_statement || '').trim()
  payload.icp_link = (data.icp_link || '').trim()
  delete payload.nav_layout_style
  delete payload.site_record
  delete payload.theme_overrides
  return payload as Settings
}
type AssetPickerTarget =
  | { type: 'siteLogo' }
  | { type: 'siteFavicon' }
  | { type: 'socialLinkIcon'; index: number }
export default function AdminSettingsPage() {
  const [isLoading, setIsLoading] = useState(true)
  const [isSaving, setIsSaving] = useState(false)
  const [settings, setSettings] = useState<Settings | null>(null)
  const [showProfileModal, setShowProfileModal] = useState(false)
  const [showPasswordModal, setShowPasswordModal] = useState(false)
  const [user, setUser] = useState<any>(null)
  const [isAssetPickerOpen, setIsAssetPickerOpen] = useState(false)
  const [assetPickerTarget, setAssetPickerTarget] = useState<AssetPickerTarget | null>(null)
  const [assetPickerSource, setAssetPickerSource] = useState<'user' | 'system'>('user')
  const { refreshSettings } = useSettings()
  const {
    register,
    handleSubmit,
    reset,
    setValue,
    watch,
    getValues,
    control,
    formState: { isDirty }
  } = useForm<Settings>({
    defaultValues: {
      site_theme: 'neo-futuristic',
      theme_background: 'theme-default' as ThemeBackgroundChoice,
      quick_links: [],
      site_statement: '',
      icp_link: '',
      footer_layout: EMPTY_FOOTER_LAYOUT,
      footer_social_links: []
    },
    mode: 'onChange'
  })
  const { fields: footerSocialFields, append: appendFooterSocialLink, remove: removeFooterSocialLink } = useFieldArray({
    control,
    name: 'footer_social_links'
  })
  const watchedLogo = watch('site_logo')
  const watchedFavicon = watch('site_favicon')
  const watchedBrandName = watch('footer_layout.brand.name' as const)
  const watchedFooterLayout = watch('footer_layout') || settings?.footer_layout || EMPTY_FOOTER_LAYOUT
  const footerSections = watchedFooterLayout.sections || []
  const watchedFooterSocialLinks = watch('footer_social_links') || []
  const backgroundPreference = (watch('theme_background') || 'theme-default') as ThemeBackgroundChoice
  const selectedThemeId = watch('site_theme') || settings?.site_theme || 'neo-futuristic'
  const previewTheme = useMemo(() => getThemeById(selectedThemeId), [selectedThemeId])
  const previewBackgroundEffect = resolveBackgroundEffect(previewTheme, backgroundPreference)
  const previewFieldBaseStyle: React.CSSProperties = {
    background: previewTheme.semantic.mutedBg,
    border: `1px solid ${previewTheme.semantic.panelBorder}`,
    borderRadius: '0.85rem',
    color: previewTheme.colors.text.primary,
    padding: '0.65rem 0.9rem',
    width: '100%',
    fontSize: '0.9rem',
    boxShadow: 'inset 0 1px 0 rgba(255, 255, 255, 0.04)'
  }
  const previewSelectStyle: React.CSSProperties = {
    ...previewFieldBaseStyle,
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'space-between',
    gap: '0.5rem'
  }
  useEffect(() => {
    fetchSettings()
    fetchUserProfile()
  }, [])
  const fetchUserProfile = async () => {
    try {
      const response = await authApi.getProfile()
      if (response.success) {
        setUser(response.data)
      }
    } catch (error) {
      console.error('????????????:', error)
    }
  }
  const fetchSettings = async () => {
    try {
      setIsLoading(true)
      const response = await settingsApi.get()
      if (response.success) {
        const { wechat_qrcode: _ignoredWechat, ...rawServer } = response.data || {}
        const { site_record: _removedRecord, nav_layout_style: _removedLayout, theme_overrides: _removedOverrides, ...serverSettings } =
          (rawServer as Partial<Settings> & Record<string, any>) || {}
        const dataWithDefaults = {
          site_theme: 'classic-blue',
          quick_links: [],
          site_statement: '',
          icp_link: '',
          ...serverSettings,
          footer_layout: serverSettings.footer_layout ?? EMPTY_FOOTER_LAYOUT,
          footer_social_links: serverSettings.footer_social_links ?? [],
          theme_background: (serverSettings.theme_background as ThemeBackgroundChoice) || 'theme-default'
        } as Settings
        if (!dataWithDefaults.footer_layout) {
          dataWithDefaults.footer_layout = EMPTY_FOOTER_LAYOUT
        }
        if (!dataWithDefaults.footer_social_links) {
          dataWithDefaults.footer_social_links = []
        }
        setSettings(dataWithDefaults)
        reset(dataWithDefaults)
      }
    } catch (error) {
      console.error('??????????:', error)
      toast.error('??????????')
    } finally {
      setIsLoading(false)
    }
  }
  const handlePasswordChanged = () => {
    fetchUserProfile()
  }
  const determineAssetSource = (url?: string | null) =>
    url && url.includes('/system-default/') ? 'system' : 'user'
  const openAssetPicker = (target: AssetPickerTarget, currentValue?: string | null) => {
    setAssetPickerSource(determineAssetSource(currentValue || ''))
    setAssetPickerTarget(target)
    setIsAssetPickerOpen(true)
  }
  const closeAssetPicker = () => {
    setIsAssetPickerOpen(false)
    setAssetPickerTarget(null)
  }
  const handleAssetSelect = (asset: SelectedAsset) => {
    if (!assetPickerTarget) return
    switch (assetPickerTarget.type) {
      case 'siteLogo':
        setValue('site_logo', asset.url, { shouldDirty: true })
        break
      case 'siteFavicon':
        setValue('site_favicon', asset.url, { shouldDirty: true })
        break
      case 'socialLinkIcon': {
        const path = `footer_social_links.${assetPickerTarget.index}.icon`
        setValue(path as any, asset.url, { shouldDirty: true })
        break
      }
      default:
        break
    }
    closeAssetPicker()
  }
  const updateFooterSections = (updater: (sections: FooterSection[]) => FooterSection[]) => {
    const currentSections = getValues('footer_layout.sections') || []
    const nextSections = updater(currentSections)
    setValue('footer_layout.sections', nextSections, { shouldDirty: true })
  }
  const addFooterSection = () => {
    const timestamp = Date.now()
    updateFooterSections(sections => [
      ...sections,
      {
        id: `section_${timestamp}`,
        title: '?¡¤???',
        description: '',
        links: []
      }
    ])
  }
  const removeFooterSection = (index: number) => {
    updateFooterSections(sections => sections.filter((_, idx) => idx !== index))
  }
  const addFooterLink = (sectionIndex: number) => {
    const timestamp = Date.now()
    updateFooterSections(sections =>
      sections.map((section, idx) => {
        if (idx !== sectionIndex) return section
        const links = section.links || []
        return {
          ...section,
          links: [
            ...links,
            {
              id: `link_${sectionIndex}_${links.length}_${timestamp}`,
              label: '??????',
              url: '/',
              target: '_self'
            }
          ]
        }
      })
    )
  }
  const removeFooterLink = (sectionIndex: number, linkIndex: number) => {
    updateFooterSections(sections =>
      sections.map((section, idx) => {
        if (idx !== sectionIndex) return section
        const links = section.links || []
        return {
          ...section,
          links: links.filter((_, lIdx) => lIdx !== linkIndex)
        }
      })
    )
  }
  const onSubmit = async (data: Settings) => {
    setIsSaving(true)
    try {
      const payload = sanitizeSettingsPayload(data)
      const response = await settingsApi.update(payload)
      if (response.success) {
        toast.success('?????????')
        setSettings(payload)
        reset(payload)
        await refreshSettings()
      } else {
        toast.error(response.message || '???????')
      }
    } catch (error) {
      console.error('???????????:', error)
      toast.error('?????????????????')
    } finally {
      setIsSaving(false)
    }
  }
  if (isLoading) {
    return (
      <AdminLayout title="??????">
        <div className="flex items-center justify-center h-64">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-tech-accent"></div>
        </div>
      </AdminLayout>
    )
  }
  return (
    <AdminLayout title="??????" description="??????????????????????">
      <div className="space-y-6">
        {/* ?????? */}
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          className="bg-gradient-to-r from-tech-dark to-tech-darker p-6 rounded-xl border border-tech-accent/20"
        >
          <div className="flex items-center space-x-3">
            <SettingsIcon className="w-6 h-6 text-white" />
            <div>
              <h1 className="text-2xl font-bold text-white">??????</h1>
              <p className="text-theme-textSecondary text-sm opacity-80">??????????????????????????ÁW???</p>
            </div>
          </div>
        </motion.div>
        {/* ?????????????? */}
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.18 }}
          className="bg-semantic-panel p-6 rounded-xl shadow-xl border border-semantic-panelBorder"
        >
          <div className="flex items-center space-x-3 mb-6">
            <Link className="w-6 h-6 text-theme-accent" />
            <div>
              <h2 className="text-xl font-bold text-theme-text">???????????</h2>
              <p className="text-sm text-theme-textSecondary">??????????????????????????????????</p>
            </div>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div className="md:col-span-2">
              <label className="block text-sm font-medium text-theme-text mb-1">???/???????</label>
              <ThemeAwareTextarea rows={3} {...register('site_statement' as const)} placeholder="?????????????????????????????????" />
            </div>
            <div>
              <label className="block text-sm font-medium text-theme-text mb-1">ICP??????</label>
              <ThemeAwareInput type="text" {...register('icp_number' as const)} placeholder="???»Ç??ICP??xxxxxxx??" />
            </div>
            <div>
              <label className="block text-sm font-medium text-theme-text mb-1">ICP????????</label>
              <ThemeAwareInput type="url" {...register('icp_link' as const)} placeholder="?????? ICP ?????????????????" />
            </div>
          </div>
        </motion.div>
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.1 }}
          className="bg-semantic-panel p-6 rounded-xl shadow-xl border border-semantic-panelBorder"
        >
          <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
              <h2 className="text-xl font-bold text-theme-text">??????</h2>
              <p className="text-sm text-theme-textSecondary">??????????????????¦Ì????????????????</p>
            </div>
            <div className="flex flex-wrap gap-3">
              <button
                type="button"
                onClick={() => setShowProfileModal(true)}
                className="px-4 py-2 rounded-lg border border-semantic-panelBorder text-theme-textSecondary hover:text-theme-text transition-colors"
              >
                ???????????
              </button>
              <button
                type="button"
                onClick={() => setShowPasswordModal(true)}
                className="px-4 py-2 rounded-lg bg-semantic-cta-primary text-white shadow-semantic hover:opacity-90 transition-opacity"
              >
                ???????
              </button>
            </div>
          </div>
        </motion.div>
        {/* ??????? */}
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.18 }}
          className="bg-semantic-panel p-6 rounded-xl shadow-xl border border-semantic-panelBorder"
        >
          <div className="flex items-center space-x-3 mb-6">
            <SettingsIcon className="w-6 h-6 text-semantic-hero-accent" />
            <div>
              <h2 className="text-xl font-bold text-theme-text">???????</h2>
              <p className="text-sm text-theme-textSecondary">???????????????????????????????§¹????</p>
            </div>
          </div>
          <div className="grid gap-4 md:grid-cols-2 mb-6">
            <div>
              <label className="block text-sm font-medium text-theme-text mb-1">??????</label>
              <ThemeAwareSelect {...register('site_theme')}>
                <option value="neo-futuristic">¦Ä?????</option>
                <option value="corporate-blue">??????</option>
                <option value="elegant-dark">???????</option>
                <option value="emerald-forest">??????</option>
                <option value="royal-amber">???????</option>
                <option value="mystic-purple">?????</option>
                <option value="minimal-pro">??????</option>
              </ThemeAwareSelect>
            </div>
            <div>
              <label className="block text-sm font-medium text-theme-text mb-1">????§¹??</label>
              <ThemeAwareSelect {...register('theme_background')}>
                {backgroundOptions.map(option => (
                  <option key={option.value} value={option.value}>
                    {option.label}
                  </option>
                ))}
              </ThemeAwareSelect>
              <p className="text-xs text-theme-textSecondary mt-2">
                ?????????????????????§¹?????????????????????
              </p>
            </div>
          </div>
          <div className="mt-6 space-y-3">
            <div className="flex items-center justify-between">
              <p className="text-sm font-semibold text-theme-text">????????</p>
              <span className="text-xs text-theme-textSecondary">
                ???????{previewTheme.name}
              </span>
            </div>
          <div className="grid gap-4 md:grid-cols-2">
            <div className="relative rounded-2xl border shadow-sm p-4 overflow-hidden" style={{ borderColor: previewTheme.semantic.panelBorder }}>
              <BackgroundRenderer effect={previewBackgroundEffect} />
              <div className="relative z-10 space-y-4" style={{ color: previewTheme.colors.text.primary }}>
                <div>
                  <p className="text-xs uppercase tracking-wide text-theme-textSecondary">??ŒÝ??</p>
                  <h4 className="text-lg font-semibold mt-1">??????</h4>
                </div>
                <p className="text-sm" style={{ color: previewTheme.colors.text.secondary }}>
                  ??????ŒÝ??????????????????
                </p>
                <div className="flex flex-wrap gap-2">
                  <span
                    className="px-3 py-1 rounded-full text-xs font-semibold"
                    style={{
                      background: previewTheme.semantic.tagBg,
                      color: previewTheme.semantic.tagText
                    }}
                  >
                    Tag
                  </span>
                  <button
                    type="button"
                    className="px-4 py-2 rounded-lg text-sm font-medium shadow-sm"
                    style={{
                      background: previewTheme.semantic.ctaPrimaryBg,
                      color: previewTheme.semantic.ctaPrimaryText
                    }}
                  >
                    ?????
                  </button>
                </div>
              </div>
            </div>
            <div className="relative rounded-2xl border shadow-inner p-4 space-y-4 overflow-hidden" style={{ borderColor: previewTheme.semantic.panelBorder }}>
              <BackgroundRenderer effect={previewBackgroundEffect} />
              <div className="relative z-10 space-y-4">
                <div>
                  <p className="text-xs uppercase tracking-wide opacity-80">?????????</p>
                  <h4 className="text-lg font-semibold">???????????</h4>
                  <p className="text-sm opacity-80">
                    ???????????????????????????¦Ì?§¹????
                  </p>
                </div>
                <div className="space-y-3">
                  <div>
                    <label className="text-xs font-medium text-theme-textSecondary block mb-1">?????</label>
                    <input
                      readOnly
                      value={watchedBrandName || '?????????????'}
                      style={previewFieldBaseStyle}
                      className="w-full bg-transparent border-none focus:outline-none"
                    />
                  </div>
                  <div>
                    <label className="text-xs font-medium text-theme-textSecondary block mb-1">???????</label>
                    <div style={previewSelectStyle}>
                      <span className="text-sm opacity-90">????? ?? ?????</span>
                      <ChevronDown className="w-4 h-4 text-theme-textSecondary" />
                    </div>
                  </div>
                  <div>
                    <label className="text-xs font-medium text-theme-textSecondary block mb-1">??????</label>
                  </div>
                </div>
              </div>
            </div>
          </div>
          </div>
        </motion.div>
        <form onSubmit={handleSubmit(onSubmit)} className="space-y-8">
          {/* ?????????? */}
          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.05 }}
            className="bg-semantic-panel p-6 rounded-xl shadow-xl border border-semantic-panelBorder"
          >
            <div className="flex items-center space-x-3 mb-6">
              <Globe className="w-6 h-6 text-theme-accent" />
              <div>
                <h2 className="text-xl font-bold text-theme-text">??????????</h2>
                <p className="text-sm text-theme-textSecondary">???1??????????????????????????????</p>
              </div>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label className="block text-sm font-medium text-theme-text mb-1">???????</label>
                <ThemeAwareInput type="text" {...register('site_name')} placeholder="ÊäÈë???????" />
              </div>
              <div>
                <label className="block text-sm font-medium text-theme-text mb-1">???????</label>
                <ThemeAwareInput type="text" {...register('company_name')} placeholder="ÊäÈë???????" />
              </div>
            </div>
          </motion.div>
          {/* Logo & Favicon */}
          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.1 }}
            className="bg-semantic-panel p-6 rounded-xl shadow-xl border border-semantic-panelBorder"
          >
            <div className="flex items-center space-x-3 mb-6">
              <ImageIcon className="w-6 h-6 text-theme-accent" />
              <div>
                <h2 className="text-xl font-bold text-theme-text">LOGO ?? Favicon</h2>
                <p className="text-sm text-theme-textSecondary">??????????? Logo ?? Favicon??</p>
              </div>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              {/* Site Logo */}
              <div className="space-y-3">
                <label className="block text-sm font-medium text-theme-text">??? Logo</label>
                <div className="flex flex-col gap-3 md:flex-row md:items-center">
                  <ThemeAwareInput type="text" {...register('site_logo')} className="flex-1" placeholder="/logo.png" />
                  <button
                    type="button"
                    onClick={() => openAssetPicker({ type: 'siteLogo' }, watchedLogo)}
                    className="inline-flex items-center px-4 py-2 rounded-lg border border-semantic-panelBorder bg-semantic-mutedBg text-theme-textSecondary hover:text-theme-text transition-colors"
                  >
                    <ImageIcon className="w-4 h-4 mr-2" />
                    ?????????
                  </button>
                </div>
                {watchedLogo && (
                  <div className="mt-2">
                    <img src={watchedLogo} alt="Logo???" className="h-12 object-contain rounded-lg border border-theme-divider" />
                  </div>
                )}
              </div>
              {/* Favicon */}
              <div className="space-y-3">
                <label className="block text-sm font-medium text-theme-text">Favicon ???</label>
                <div className="flex flex-col gap-3 md:flex-row md:items-center">
                  <ThemeAwareInput type="text" {...register('site_favicon')} className="flex-1" placeholder="/favicon.ico" />
                  <button
                    type="button"
                    onClick={() => openAssetPicker({ type: 'siteFavicon' }, watchedFavicon)}
                    className="inline-flex items-center px-4 py-2 rounded-lg border border-semantic-panelBorder bg-semantic-mutedBg text-theme-textSecondary hover:text-theme-text transition-colors"
                  >
                    <ImageIcon className="w-4 h-4 mr-2" />
                    ?????????
                  </button>
                </div>
                {watchedFavicon && (
                  <div className="mt-2">
                    <img src={watchedFavicon} alt="Favicon???" className="h-12 w-12 object-contain rounded-lg border border-theme-divider" />
                  </div>
                )}
              </div>
            </div>
          </motion.div>
          {/* ??? & ?????*/}
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.15 }}
          className="bg-semantic-panel p-6 rounded-xl shadow-xl border border-semantic-panelBorder"
        >
          <div className="flex items-center space-x-3 mb-6">
            <Building className="w-6 h-6 text-theme-accent" />
            <div>
              <h2 className="text-xl font-bold text-theme-text">??????</h2>
              <p className="text-sm text-theme-textSecondary">????????????´Â?????????</p>
            </div>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div>
              <label className="block text-sm font-medium text-theme-text mb-1">???????</label>
              <ThemeAwareInput type="email" {...register('contact_email')} placeholder="contact@example.com" />
            </div>
            <div>
              <label className="block text-sm font-medium text-theme-text mb-1">????´Â</label>
              <ThemeAwareInput type="tel" {...register('contact_phone')} placeholder="400-123-4567" />
            </div>
            <div className="md:col-span-3">
              <label className="block text-sm font-medium text-theme-text mb-1">??????</label>
              <ThemeAwareInput type="text" {...register('address')} placeholder="??????????" />
            </div>
          </div>
        </motion.div>
          {/* ??????? */}
          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.2 }}
          className="bg-semantic-panel p-6 rounded-xl shadow-xl border border-semantic-panelBorder space-y-6"
          >
            <div className="flex items-center space-x-3">
              <Link className="w-6 h-6 text-theme-accent" />
              <div>
                <h2 className="text-xl font-bold text-theme-text">???????????????</h2>
                <p className="text-sm text-theme-textSecondary">??????????????????????????????????§Ö??????</p>
              </div>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label className="block text-sm font-medium text-theme-text mb-1">???????</label>
                <ThemeAwareInput
                  type="text"
                  {...register('footer_layout.brand.name' as const)}
                  className="px-3"
                  placeholder="??§Õ??????????"
                />
              </div>
              <div className="md:col-span-2">
                <label className="block text-sm font-medium text-theme-text mb-1">???????</label>
                <ThemeAwareInput
                  type="text"
                  {...register('footer_layout.brand.description' as const)}
                  className="px-3"
                  placeholder="??????????????"
                />
              </div>
            </div>
            <div className="pt-4 border-t border-semantic-dividerStrong">
              <h3 className="text-sm font-semibold text-theme-text mb-3">???????</h3>
              <div className="space-y-4">
                {footerSections.map((section, sectionIndex) => (
                  <div key={section.id || sectionIndex} className="border border-semantic-panelBorder rounded-xl p-4 space-y-4">
                    <div className="flex items-center justify-between">
                      <div className="flex-1 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-theme-text mb-1">???????</label>
                          <ThemeAwareInput
                            type="text"
                            {...register(`footer_layout.sections.${sectionIndex}.title` as const)}
                            className="px-3"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-theme-text mb-1">???????</label>
                          <ThemeAwareInput
                            type="text"
                            {...register(`footer_layout.sections.${sectionIndex}.description` as const)}
                            className="px-3"
                            placeholder="????????????????????"
                          />
                        </div>
                      </div>
                      <button
                        type="button"
                        onClick={() => removeFooterSection(sectionIndex)}
                        className="p-2 text-red-500 hover:bg-red-50 rounded-lg transition-colors ml-4"
                      >
                        <Trash2 className="w-5 h-5" />
                      </button>
                    </div>
                    <div className="space-y-3">
                      {(section.links || []).map((link, linkIndex) => {
                        const labelField = `footer_layout.sections.${sectionIndex}.links.${linkIndex}.label` as const
                        const urlField = `footer_layout.sections.${sectionIndex}.links.${linkIndex}.url` as const
                        const targetField = `footer_layout.sections.${sectionIndex}.links.${linkIndex}.target` as const
                        return (
                          <div key={link.id || linkIndex} className="grid grid-cols-1 md:grid-cols-4 gap-3">
                            <div>
                              <label className="block text-sm font-medium text-theme-text mb-1">???????</label>
                              <ThemeAwareInput type="text" {...register(labelField)} className="px-3" />
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-theme-text mb-1">??????</label>
                              <ThemeAwareInput
                                type="text"
                                {...register(urlField)}
                                className="px-3"
                                placeholder="/about ??https://example.com"
                              />
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-theme-text mb-1">?????</label>
                              <ThemeAwareSelect {...register(targetField)} className="px-3">
                                <option value="_self">???????</option>
                                <option value="_blank">?¡ä???</option>
                              </ThemeAwareSelect>
                            </div>
                            <div className="flex items-end justify-between md:justify-end">
                              <button
                                type="button"
                                onClick={() => removeFooterLink(sectionIndex, linkIndex)}
                                className="inline-flex items-center px-3 py-2 text-sm text-red-500 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                              >
                                <Trash2 className="w-4 h-4 mr-2" />
                                ???
                              </button>
                            </div>
                          </div>
                        )
                      })}
                      <button
                        type="button"
                        onClick={() => addFooterLink(sectionIndex)}
                        className="inline-flex items-center px-3 py-2 text-sm rounded-lg border border-theme-divider bg-theme-surfaceAlt text-theme-textSecondary hover:text-theme-text transition-colors"
                      >
                        <Plus className="w-4 h-4 mr-2" />
                        ???????
                      </button>
                    </div>
                  </div>
                ))}
                <button
                  type="button"
                  onClick={addFooterSection}
                  className="inline-flex items-center px-4 py-2 bg-tech-accent text-white rounded-lg hover:bg-tech-accent/90 transition-colors"
                >
                  <Plus className="w-4 h-4 mr-2" />
                  ??????
                </button>
              </div>
            </div>
            <div className="pt-4 border-t border-semantic-dividerStrong">
              <h3 className="text-sm font-semibold text-theme-text mb-3">?ÁWy??????</h3>
              <div className="space-y-4">
                {footerSocialFields.map((field, index) => {
                  const currentColor = (watchedFooterSocialLinks[index]?.color as string) || ''
                  const colorPreview = isValidHexColor(currentColor) ? currentColor : '#0ea5e9'
                  return (
                  <div key={field.id} className="grid grid-cols-1 md:grid-cols-5 gap-3 border border-theme-divider rounded-lg p-3 bg-theme-surfaceAlt/60">
                    <div>
                      <label className="block text-sm font-medium text-theme-text mb-1">???</label>
                      <ThemeAwareInput
                        type="text"
                        {...register(`footer_social_links.${index}.id` as const)}
                        className="px-3"
                        placeholder="wechat"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-theme-text mb-1">???????</label>
                      <ThemeAwareInput type="text" {...register(`footer_social_links.${index}.label` as const)} className="px-3" />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-theme-text mb-1">??????</label>
                      <ThemeAwareInput type="text" {...register(`footer_social_links.${index}.url` as const)} className="px-3" />
                    </div>
                    <div className="space-y-2">
                      <label className="block text-sm font-medium text-theme-text">????????????</label>
                      <div className="flex flex-col gap-2 sm:flex-row sm:items-center">
                        <ThemeAwareInput
                          type="text"
                          {...register(`footer_social_links.${index}.icon` as const)}
                          readOnly
                          className="flex-1 cursor-not-allowed bg-theme-surfaceAlt text-theme-textSecondary"
                          placeholder="????????????"
                        />
                        <button
                          type="button"
                          onClick={() => openAssetPicker(
                            { type: 'socialLinkIcon', index },
                            getValues(`footer_social_links.${index}.icon` as const)
                          )}
                          className="inline-flex items-center px-3 py-2 rounded-lg border border-theme-divider bg-theme-surfaceAlt text-theme-textSecondary hover:text-theme-text transition-colors text-sm"
                        >
                          <ImageIcon className="w-4 h-4 mr-2" />
                          ?????????
                        </button>
                      </div>
                    </div>
                    <div className="space-y-2 md:col-span-2">
                      <label className="block text-sm font-medium text-theme-text mb-1">????????????</label>
                      <div className="flex flex-col gap-2 sm:flex-row sm:items-center">
                        <input
                          type="color"
                          value={colorPreview}
                          onChange={event => handleSocialColorChange(index, event.target.value)}
                          className="h-10 w-16 rounded border border-theme-divider bg-transparent cursor-pointer"
                        />
                        <ThemeAwareInput
                          type="text"
                          placeholder="???? #0EA5E9"
                          {...register(`footer_social_links.${index}.color` as const)}
                          className="flex-1"
                        />
                        <button
                          type="button"
                          onClick={() => handleSocialColorChange(index, '')}
                          className="px-3 py-2 text-xs rounded-lg border border-theme-divider text-theme-textSecondary hover:text-theme-text transition-colors"
                        >
                          ??????
                        </button>
                      </div>
                      <p className="text-xs text-theme-textSecondary">????????????????????? SVG ?????????</p>
                    </div>
                    <div className="flex items-end space-x-2">
                      <div className="flex-1">
                        <label className="block text-sm font-medium text-theme-text mb-1">?????</label>
                        <ThemeAwareSelect {...register(`footer_social_links.${index}.target` as const)} className="px-3">
                          <option value="_blank">?¡ä???</option>
                          <option value="_self">???????</option>
                        </ThemeAwareSelect>
                      </div>
                      <button
                        type="button"
                        onClick={() => removeFooterSocialLink(index)}
                        className="p-2 text-red-500 hover:bg-red-50 rounded-lg transition-colors"
                      >
                        <Trash2 className="w-5 h-5" />
                      </button>
                    </div>
                  </div>
                ))}
                <button
                  type="button"
                  onClick={() =>
                    appendFooterSocialLink({
                      id: `social_${Date.now()}`,
                      label: '?¦Ì??ÁW??',
                      url: '',
                      target: '_blank',
                      icon: ''
                    })
                  }
                  className="inline-flex items-center px-4 py-2 bg-tech-accent text-white rounded-lg hover:bg-tech-accent/90 transition-colors"
                >
                  <Plus className="w-4 h-4 mr-2" />
                  ????ÁW????
                </button>
              </div>
            </div>
          </motion.div>
          {/* ???????? */}
          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.25 }}
          className="bg-theme-surface p-6 rounded-xl shadow-xl border border-theme-divider"
          >
            <div className="flex items-center space-x-3 mb-4">
            <SettingsIcon className="w-6 h-6 text-theme-accent" />
              <div>
                <h2 className="text-xl font-bold text-theme-text">????????</h2>
                <p className="text-sm text-theme-textSecondary">????????????????¡¤?????????????§¹????</p>
              </div>
            </div>
            <div className="rounded-2xl border border-semantic-panelBorder overflow-hidden">
              <ThemeAwareFooter
                siteName={watchedBrandName || watch('company_name') || '??????'}
                icpNumber={watch('icp_number')}
                contactInfo={{
                  email: watch('contact_email'),
                  phone: watch('contact_phone'),
                  address: watch('address')
                }}
                footerLayout={watchedFooterLayout}
                footerSocialLinks={watchedFooterSocialLinks}
              />
            </div>
          </motion.div>
          {/* ???Ë®? */}
          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.3 }}
            className="flex justify-end space-¨¤-4">
            <button
              type="button"
              onClick={() => reset(settings || {})}
              className="px-6 py-2 border border-theme-divider text-theme-textSecondary rounded-lg hover:text-theme-text hover:bg-theme-surfaceAlt transition-colors"
              disabled={!isDirty || isSaving}
            >
              ????
            </button>
            <button
              type="submit"
              disabled={isSaving}
              className="inline-flex items-center px-6 py-2 bg-tech-accent text-white rounded-lg hover:bg-tech-accent/90 transition-colors disabled:opacity-50"
            >
              <Save className="w-4 h-4 mr-2" />
              {isSaving ? '??????...' : '????????'}
            </button>
          </motion.div>
          {/* ¦Ä????????*/}
          {isDirty && (
            <motion.div initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
              <div className="flex items-center">
                <AlertTriangle className="w-5 h-5 text-yellow-600 mr-2" />
                <p className="text-sm text-yellow-700">?????¦Ä???????????????????¨¢?</p>
              </div>
            </motion.div>
          )}
        </form>
        <AssetPickerModal
          isOpen={isAssetPickerOpen}
          onClose={closeAssetPicker}
          onSelect={handleAssetSelect}
          initialSource={assetPickerSource}
        />
        <UserProfileModal
          isOpen={showProfileModal}
          user={user}
          onClose={() => setShowProfileModal(false)}
          onProfileUpdated={handlePasswordChanged}
        />
        <ChangePasswordModal
          isOpen={showPasswordModal}
          onClose={() => setShowPasswordModal(false)}
          onPasswordChanged={handlePasswordChanged}
        />
      </div>
    </AdminLayout>
  )
}


  const handleSocialColorChange = (index: number, value: string) => {
    setValue(`footer_social_links.${index}.color` as const, value, { shouldDirty: true })
  }

  const isValidHexColor = (value: string) => /^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(value.trim())

